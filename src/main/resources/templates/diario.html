<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Mi Diario Emocional</title>
    
    <!-- Spring Security CSRF Token -->
    <meta name="_csrf" th:content="${_csrf?.token}" th:if="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" th:if="${_csrf?.headerName}"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        
        :root {
            --color-bg: #030303; 
            --color-card: rgba(10, 10, 20, 0.95); 
            --color-card-light: rgba(20, 20, 40, 0.95);
            --color-text: #EBEBEB;
            --color-primary-accent: #A084E8;
            --color-secondary-accent: #00FFFF;
            --shadow-primary: rgba(160, 132, 232, 0.45);
            --border-color: rgba(255, 255, 255, 0.15);
            --transition-time: 0.3s;
        }

        body.light-mode {
            --color-bg: #F0F4F8;
            --color-card: #FFFFFF;
            --color-card-light: #F8F8F8;
            --color-text: #212529;
            --color-primary-accent: #6C5CE7; 
            --color-secondary-accent: #00BCD4; 
            --shadow-primary: rgba(108, 92, 231, 0.2);
            --border-color: #E0E0E0;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Inter', sans-serif;
            transition: all var(--transition-time) ease-in-out;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .sidebar {
            background-color: var(--color-card);
            border-right: 1px solid var(--border-color);
            transition: all var(--transition-time) ease;
        }
        .editor-area {
            background-color: var(--color-bg);
            transition: all var(--transition-time) ease;
        }

        .note-item {
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s, transform 0.2s;
        }
        .note-item:hover {
            background-color: rgba(160, 132, 232, 0.1);
        }
        .note-item.active {
            background-color: rgba(160, 132, 232, 0.2);
            border-left: 4px solid var(--color-primary-accent);
            transform: scale(1.02);
        }
        
        .btn-primary-accent {
            background-color: var(--color-primary-accent);
            color: var(--color-bg); 
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .btn-primary-accent:hover {
            background-color: color-mix(in srgb, var(--color-primary-accent) 90%, black);
            box-shadow: 0 4px 15px var(--shadow-primary);
        }

        .btn-secondary-accent {
            background-color: var(--color-secondary-accent);
            color: var(--color-bg); 
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .btn-secondary-accent:hover {
            background-color: color-mix(in srgb, var(--color-secondary-accent) 90%, black);
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
        }

        .emoji-button {
            background-color: var(--color-card-light);
            border: 2px solid var(--border-color);
            width: 60px;
            height: 60px;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .emoji-button:hover {
            transform: scale(1.1);
            border-color: var(--color-secondary-accent);
        }
        .emoji-button.selected {
            border-color: var(--color-primary-accent);
            box-shadow: 0 0 10px var(--shadow-primary), inset 0 0 8px var(--shadow-primary);
            transform: scale(1.15);
        }
        .emoji-button.selected::after {
            content: '‚úî';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.8rem;
            color: var(--color-bg);
            background-color: var(--color-primary-accent);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 16px;
            text-align: center;
        }

        .textarea-editor {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--color-text);
            resize: none;
            transition: border-color 0.2s;
        }
        .textarea-editor:focus {
            outline: none;
            border-color: var(--color-primary-accent);
            box-shadow: 0 0 5px rgba(160, 132, 232, 0.5);
        }
        
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: var(--color-primary-accent);
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        #new-note-mobile {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
        }

        .toast-show {
            animation: fadeInOut 5s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
    </style>
    
    <script th:inline="javascript">
        const EMOJI_MAP = {
            'Felicidad': 'üòä',
            'Tristeza': 'üòî',
            'Ansiedad': 'üò∞',
            'Enojo': 'üò°',
            'Calma': 'üßò',
            'Confusi√≥n': 'ü§î',
            'Frustracion': 'üòñ',
            'Esperanza': 'üôè',
            'Miedo': 'üò®',
            'Neutral': 'üòê',
        };

        const GUIDED_PROMPTS = [
            "¬øQu√© fue lo m√°s inesperado que pas√≥ hoy y c√≥mo te hizo sentir?",
            "Si pudieras hablar con tu yo del pasado (hace 1 a√±o), ¬øqu√© le dir√≠as y por qu√©?",
            "Describe una situaci√≥n de estr√©s o conflicto de hoy. ¬øC√≥mo reaccionaste y c√≥mo te gustar√≠a reaccionar la pr√≥xima vez?",
            "¬øQu√© peque√±o logro de hoy est√°s orgulloso/a de haber conseguido?",
            "Si tu estado de √°nimo actual fuera un color, ¬øcu√°l ser√≠a y por qu√©?",
            "¬øHay algo que te est√© dando vueltas en la cabeza y que necesites soltar?",
            "¬øQu√© cosa hiciste hoy que te acerc√≥ a ser la persona que quieres ser?",
            "Nombra 3 cosas por las que te sientes agradecido/a en este momento.",
        ];
        
        function getEmoji(emotion) {
            return EMOJI_MAP[emotion] || 'üìù';
        }

        function formatServerDate(isoDateString) {
            let date;
            if (isoDateString) {
                date = new Date(isoDateString);
            } else {
                date = new Date();
            }
            
            if (isNaN(date)) {
                return 'Fecha Inv√°lida';
            }

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }
    </script>
</head>

<body class="flex flex-col md:flex-row h-screen">

    <!-- BARRA LATERAL -->
    <div id="sidebar-container" class="sidebar w-full md:w-80 flex flex-col h-1/2 md:h-full overflow-hidden absolute md:relative z-10 transition-transform transform md:translate-x-0 -translate-x-full">
        
        <div class="p-4 flex justify-between items-center sticky top-0 bg-gray-900 bg-opacity-90 backdrop-blur-sm z-20"
             style="border-color: var(--border-color); border-bottom: 1px solid var(--border-color);">
            <h2 class="text-xl font-bold" style="color: var(--color-primary-accent);">
                <i class="bi bi-journal-check me-2"></i> Mi Diario
            </h2>
            <button id="new-note-desktop" onclick="handleNewEntry()" class="btn-primary-accent p-2 rounded-full shadow-lg hover:shadow-2xl" title="Nueva Entrada">
                <i class="bi bi-plus-lg"></i>
            </button>
            <button id="close-sidebar-btn" class="md:hidden text-lg p-1" onclick="toggleSidebar(false)">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div id="entries-list" class="flex-grow overflow-y-auto custom-scroll p-0">
            <div th:if="${#lists.isEmpty(entradas)}" class="p-4 text-center text-gray-500" id="no-entries-message">
                <i class="bi bi-journal-x text-4xl mb-2"></i>
                <p>A√∫n no tienes entradas. ¬°Registra tu primera emoci√≥n!</p>
            </div>

            <div th:each="entrada : ${entradas}" 
                 th:data-id="${entrada.id}" 
                 th:data-emocion="${entrada.emocion}"
                 th:data-descripcion="${entrada.descripcion}"
                 th:data-fecha="${#temporals.format(entrada.fechaActualizacion, 'yyyy-MM-dd HH:mm:ss')}" 
                 onclick="handleSelectEntry(this)"
                 class="note-item p-4" 
                 th:classappend="${entrada.id == notaSeleccionadaId ? 'active' : ''}">
                
                <h3 class="font-semibold truncate text-lg">
                    <span th:text="${T(Utilidades.DiarioUtils).getEmoji(entrada.emocion)}" class="mr-2 text-xl" aria-hidden="true">üìù</span>
                    <span th:text="${entrada.emocion}">Emoci√≥n Registrada</span>
                </h3>
                
                <p class="text-sm text-gray-400 mt-1 truncate" th:text="${entrada.descripcion}"></p>
                <span class="text-xs mt-2 block" style="color: var(--color-secondary-accent);" th:text="${#temporals.format(entrada.fechaActualizacion, 'dd/MM/yyyy HH:mm')}">Fecha</span>
            </div>
            
        </div>
    </div>
    
    <button id="new-note-mobile" onclick="handleNewEntry(); toggleSidebar(false);" 
            class="md:hidden btn-primary-accent p-4 rounded-full shadow-2xl">
        <i class="bi bi-plus-lg text-2xl"></i>
    </button>
    
    <button id="open-sidebar-btn" class="md:hidden fixed top-4 left-4 z-30 p-2 rounded-full" style="background-color: var(--color-card); color: var(--color-primary-accent);" onclick="toggleSidebar(true)">
        <i class="bi bi-list text-2xl"></i>
    </button>

    <!-- √ÅREA DE EDITOR -->
    <div id="editor-container" class="editor-area flex-grow p-4 md:p-8 flex flex-col">
        
        <div class="mb-6 text-center border-b pb-4" style="border-color: var(--border-color);">
            <h1 class="text-4xl font-extrabold mb-1" style="color: var(--color-primary-accent);">
                ¬°Hola, <span th:text="${usuarioNombre}"></span>!
            </h1>
            <p class="text-lg text-gray-400">
                <span id="welcome-message">¬øC√≥mo est√° tu mundo hoy?</span>
            </p>
        </div>
        
        <div id="message-box" class="fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-xl" style="display: none;"></div>

        <!-- BARRA DE HERRAMIENTAS -->
        <div id="editor-toolbar" class="flex justify-between items-center mb-6 sticky top-0 pt-2 pb-4 z-10" 
             style="background-color: var(--color-bg); border-bottom: 1px solid var(--border-color);">
            
            <span id="entry-status" class="text-sm text-gray-400">Selecciona o crea una entrada.</span>
            
            <div class="flex space-x-2">
                <!-- Bot√≥n de An√°lisis IA -->
                <button id="ai-analysis-btn" onclick="analyzeCurrentEntry()" class="btn-secondary-accent px-4 py-2 rounded-lg flex items-center hidden" 
                        title="Analizar con IA" disabled>
                    <i class="bi bi-robot me-2"></i>
                    <span>Analizar</span>
                </button>
                
                <!-- Bot√≥n de Eliminar -->
                <button id="delete-btn" onclick="showConfirmDeleteModal()" class="p-2 rounded-full text-red-400 hover:bg-red-900/50 transition-all hidden" 
                        title="Eliminar Entrada">
                    <i class="bi bi-trash-fill text-xl"></i>
                </button>
                
                <!-- Bot√≥n de Guardar -->
                <button id="save-btn" onclick="handleSaveOrUpdate()" class="btn-primary-accent px-4 py-2 rounded-lg flex items-center" disabled>
                    <i id="save-icon" class="bi bi-save-fill me-2"></i>
                    <span id="save-text">Guardar</span>
                </button>
            </div>
        </div>

        <!-- FORMULARIO DEL EDITOR -->
        <form id="entry-form" class="flex flex-col flex-grow">
            <input type="hidden" id="entry-id" name="id" value="" />
            
            <select id="entry-emocion" name="emocion" class="hidden" required disabled>
                <option value="Felicidad">Felicidad</option>
                <option value="Tristeza">Tristeza</option>
                <option value="Ansiedad">Ansiedad</option>
                <option value="Enojo">Enojo</option>
                <option value="Calma">Calma</option>
                <option value="Confusi√≥n">Confusi√≥n</option>
                <option value="Frustracion">Frustraci√≥n</option>
                <option value="Esperanza">Esperanza</option>
                <option value="Miedo">Miedo</option>
                <option value="Neutral">Neutral</option>
            </select>
            
            <label class="text-sm block mb-2 text-gray-400">1. Selecciona c√≥mo te sientes:</label>
            <div id="emoji-picker" class="flex flex-wrap gap-4 justify-center p-4 mb-8 rounded-lg"
                 style="background-color: var(--color-card-light);">
            </div>

            <div class="flex justify-between items-center mb-2">
                <label for="entry-descripcion" class="text-sm block text-gray-400">2. Describe tus pensamientos:</label>
                <button type="button" id="get-prompt-btn" onclick="showRandomPrompt()" class="text-xs font-semibold hover:underline p-1 rounded" style="color: var(--color-secondary-accent);">
                    ¬øNecesitas ayuda para empezar?
                </button>
            </div>
            <textarea id="entry-descripcion" name="descripcion" 
                      class="textarea-editor flex-grow text-lg p-4 custom-scroll rounded-lg" 
                      placeholder="Escribe tus reflexiones aqu√≠..." required
                      oninput="checkChanges();"
                      disabled></textarea>
                      
            <div class="mt-4 text-right text-xs text-gray-500">
                √öltima actualizaci√≥n: <span id="entry-date-display">--</span>
            </div>
        </form>
        
        <!-- √ÅREA DE RESPUESTA DEL ASISTENTE IA -->
        <div id="ai-assistant-box" class="mt-8 p-4 rounded-xl border-t-2" style="border-color: var(--color-secondary-accent); background-color: var(--color-card-light);">
            <h3 class="text-xl font-bold mb-3 flex items-center" style="color: var(--color-secondary-accent);">
                <i class="bi bi-robot me-2"></i> Asistente Praxis AI
            </h3>
            <div id="ai-response-content" class="text-gray-300 italic min-h-[40px] flex items-center">
                <p>Haz clic en "Analizar" para obtener insights sobre tu entrada.</p>
            </div>
            <div id="ai-sources" class="mt-2 text-xs text-gray-500 hidden"></div>
        </div>
        
    </div>
    
    <!-- MODAL DE CONFIRMACI√ìN DE ELIMINACI√ìN -->
    <div id="confirm-modal" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center hidden">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-sm" style="background-color: var(--color-card);">
            <h3 class="text-xl font-bold mb-4 text-red-400">¬°Atenci√≥n! Est√°s a punto de eliminar.</h3>
            <p class="text-gray-300 mb-6">
                ¬øEst√°s completamente seguro/a de que deseas eliminar esta entrada de forma permanente?
                <span class="font-semibold block mt-2">(Esta acci√≥n no se puede deshacer).</span>
            </p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" onclick="hideConfirmDeleteModal()" class="px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-700/50 transition">
                    Cancelar
                </button>
                <button id="confirm-delete-btn" onclick="confirmDeleteEntry()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                    S√≠, Eliminar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bot√≥n de cambio de tema -->
    <i class="bi bi-moon-fill theme-toggle-switch fixed top-4 right-4 z-50 text-2xl cursor-pointer p-2 rounded-full hover:bg-gray-800" 
       id="theme-toggle" role="button" title="Cambiar Tema" 
       style="color: var(--color-primary-accent); background-color: var(--color-card);"></i>

    <!-- L√ìGICA JAVASCRIPT CON RECARGA AUTOM√ÅTICA -->
    <script>
        // --- Configuraci√≥n de la IA ---
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=";
        const API_KEY = "AIzaSyCe3iqew724T5MoSBY-nCyYIuVHj9hD61o";
        const AI_ENABLED = API_KEY && API_KEY.length > 0;

        // Variables globales del estado
        let currentEntryId = null;
        let originalEmocion = '';
        let originalDescripcion = '';
        let isAnalyzing = false;
        
        // Variables para CSRF
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        
        // Referencias de elementos DOM
        const sidebarContainer = document.getElementById('sidebar-container');
        const entryIdInput = document.getElementById('entry-id');
        const emocionSelect = document.getElementById('entry-emocion');
        const descripcionTextarea = document.getElementById('entry-descripcion');
        const dateDisplay = document.getElementById('entry-date-display');
        const saveBtn = document.getElementById('save-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const aiAnalysisBtn = document.getElementById('ai-analysis-btn');
        const entryStatus = document.getElementById('entry-status');
        const messageBox = document.getElementById('message-box');
        const entriesList = document.getElementById('entries-list');
        const themeToggle = document.getElementById('theme-toggle');
        const confirmModal = document.getElementById('confirm-modal');
        const emojiPicker = document.getElementById('emoji-picker');
        const welcomeMessage = document.getElementById('welcome-message');
        const aiResponseContent = document.getElementById('ai-response-content');
        const aiSourcesContainer = document.getElementById('ai-sources');

        // --- Inicializaci√≥n ---
        window.onload = function() {
            initTheme();
            emocionSelect.disabled = false;
            descripcionTextarea.disabled = false;
            renderEmojiPicker();

            if (!AI_ENABLED) {
                aiResponseContent.innerHTML = `
                    <div class="text-yellow-400">
                        <p class="font-bold">‚ö†Ô∏è Asistente AI No Configurado</p>
                        <p class="text-sm mt-1">Para activar el an√°lisis de IA, configura tu API Key.</p>
                    </div>
                `;
            }

            const initialEntryId = /*[[${notaSeleccionadaId}]]*/ null; 
            if (initialEntryId) {
                const selectedElement = entriesList.querySelector(`[data-id="${initialEntryId}"]`);
                if (selectedElement) handleSelectEntry(selectedElement);
            } else {
                const firstEntry = entriesList.querySelector('.note-item');
                if (firstEntry) handleSelectEntry(firstEntry);
                else handleNewEntry();
            }
        };

        // --- Funciones de UI ---
        function renderEmojiPicker() {
            emojiPicker.innerHTML = '';
            Object.keys(EMOJI_MAP).forEach(emotionName => {
                const emoji = EMOJI_MAP[emotionName];
                const button = document.createElement('div');
                button.className = 'emoji-button group';
                button.setAttribute('data-emotion', emotionName);
                button.innerHTML = `
                    ${emoji}
                    <span class="absolute -bottom-8 opacity-0 group-hover:opacity-100 transition-opacity text-sm font-medium" style="color: var(--color-text);">${emotionName}</span>
                `;
                button.onclick = () => selectEmotion(emotionName, button);
                emojiPicker.appendChild(button);
            });
        }
        
        function selectEmotion(emotionName, buttonElement) {
            document.querySelectorAll('.emoji-button').forEach(btn => btn.classList.remove('selected'));
            if (buttonElement) buttonElement.classList.add('selected');
            emocionSelect.value = emotionName;
            checkChanges();
        }

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            messageBox.classList.add('toast-show');
            messageBox.style.backgroundColor = isError ? 'rgba(220, 38, 38, 0.9)' : 'rgba(124, 58, 237, 0.9)';
            messageBox.style.color = '#FFFFFF';
            setTimeout(() => {
                messageBox.classList.remove('toast-show');
                messageBox.style.display = 'none';
            }, 5000);
        }

        function showRandomPrompt() {
            if (descripcionTextarea.value.trim().length > 0) {
                 showMessage('Ya tienes algo escrito. Borra la caja si quieres un nuevo prompt.', false);
                 return;
            }
            const randomIndex = Math.floor(Math.random() * GUIDED_PROMPTS.length);
            descripcionTextarea.value = GUIDED_PROMPTS[randomIndex] + "\n\nMi respuesta:\n";
            descripcionTextarea.focus();
            checkChanges();
        }

        function toggleSidebar(show) {
            if (show) sidebarContainer.classList.remove('-translate-x-full');
            else sidebarContainer.classList.add('-translate-x-full');
        }
        
        // --- L√≥gica del Asistente IA ---
        async function analyzeCurrentEntry() {
            if (!AI_ENABLED || isAnalyzing) return;
            
            const currentDescripcion = descripcionTextarea.value.trim();
            if (!currentDescripcion || currentDescripcion.length < 10) {
                showMessage('Escribe al menos 10 caracteres para analizar.', true);
                return;
            }

            isAnalyzing = true;
            aiAnalysisBtn.disabled = true;
            aiAnalysisBtn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin me-2"></i> Analizando...';

            try {
                await analyzeEntryAndDisplayAdvice(currentDescripcion);
                showMessage('An√°lisis completado con √©xito!');
            } catch (error) {
                console.error('Error en an√°lisis:', error);
                showMessage('Error en el an√°lisis. Intenta nuevamente.', true);
            } finally {
                isAnalyzing = false;
                aiAnalysisBtn.disabled = false;
                aiAnalysisBtn.innerHTML = '<i class="bi bi-robot me-2"></i><span>Analizar</span>';
            }
        }

        async function analyzeEntryAndDisplayAdvice(entryText) {
            if (!AI_ENABLED) return;

            aiResponseContent.innerHTML = '<p class="text-center py-4"><i class="bi bi-arrow-repeat animate-spin text-2xl" style="color: var(--color-primary-accent);"></i> Analizando tus pensamientos...</p>';
            aiSourcesContainer.classList.add('hidden');

            const systemPrompt = "Eres un asistente emocional compasivo y no-juzgador. Analiza la entrada de diario del usuario. Ofrece una reflexi√≥n emp√°tica y de apoyo basada en el sentimiento expresado, seguida de un consejo pr√°ctico y orientado a la acci√≥n. Mant√©n un tono tranquilo y alentador, enfocado en la salud mental y el bienestar. Responde en espa√±ol.";
            
            const payload = {
                contents: [{
                    parts: [{
                        text: `${systemPrompt}\n\nEntrada del diario a analizar: "${entryText}"`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            };

            try {
                const response = await fetch(GEMINI_API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const cleanText = text.replace(/\*\*(.*?)\*\*/g, '$1').trim();
                    aiResponseContent.innerHTML = `<p class="whitespace-pre-line">${cleanText}</p>`;
                } else {
                    aiResponseContent.innerHTML = '<p class="text-yellow-400">El asistente AI no pudo generar una respuesta clara.</p>';
                }
            } catch (error) {
                console.error('Error en an√°lisis IA:', error);
                aiResponseContent.innerHTML = '<p class="text-red-400">Error al conectar con el servicio de IA.</p>';
                throw error;
            }
        }
        
        // --- L√≥gica del Editor (CRUD) CON RECARGA AUTOM√ÅTICA ---
        function checkChanges() {
            const currentEmocion = emocionSelect.value;
            const currentDescripcion = descripcionTextarea.value.trim();
            
            if (!currentDescripcion || currentDescripcion.length < 1 || !currentEmocion) {
                saveBtn.disabled = true;
                return;
            }
            
            const isChanged = currentEmocion !== originalEmocion || currentDescripcion !== originalDescripcion;
            saveBtn.disabled = !isChanged;
            document.getElementById('save-text').textContent = currentEntryId ? 'Actualizar' : 'Guardar';
        }

        function handleSelectEntry(element) {
            document.querySelectorAll('.note-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            currentEntryId = element.dataset.id;
            originalEmocion = element.dataset.emocion;
            originalDescripcion = element.dataset.descripcion;
            
            entryIdInput.value = currentEntryId;
            emocionSelect.value = originalEmocion; 
            selectEmotion(originalEmocion, null);
            descripcionTextarea.value = originalDescripcion;
            dateDisplay.textContent = formatServerDate(element.dataset.fecha);
            
            entryStatus.textContent = 'Editando Entrada #' + currentEntryId;
            deleteBtn.classList.remove('hidden');
            
            // Mostrar bot√≥n de an√°lisis si hay suficiente texto
            if (AI_ENABLED && originalDescripcion && originalDescripcion.length >= 10) {
                aiAnalysisBtn.classList.remove('hidden');
                aiAnalysisBtn.disabled = false;
            } else {
                aiAnalysisBtn.classList.add('hidden');
            }
            
            welcomeMessage.textContent = "Es bueno ver tu progreso. ¬øHay algo nuevo hoy?";
            checkChanges();
            
            if (window.innerWidth < 768) toggleSidebar(false);
        }

        function handleNewEntry() {
            document.querySelectorAll('.note-item').forEach(el => el.classList.remove('active'));

            currentEntryId = null;
            originalEmocion = '';
            originalDescripcion = '';
            
            entryIdInput.value = '';
            emocionSelect.value = ''; 
            selectEmotion('', null);
            descripcionTextarea.value = '';
            dateDisplay.textContent = formatServerDate();
            
            entryStatus.textContent = 'Creando Nueva Entrada';
            deleteBtn.classList.add('hidden');
            aiAnalysisBtn.classList.add('hidden');
            welcomeMessage.textContent = "Escribir ayuda a ordenar la mente. ¬øPor d√≥nde quieres empezar?";
            
            aiResponseContent.innerHTML = '<p>Haz clic en "Analizar" para obtener insights sobre tu entrada.</p>';
            aiSourcesContainer.classList.add('hidden');
            
            checkChanges(); 
            descripcionTextarea.focus(); 
        }

        async function handleSaveOrUpdate() {
            if (saveBtn.disabled) return;
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin me-2"></i> Procesando...';
            
            const isNew = currentEntryId === null || currentEntryId === '';
            const url = isNew ? '/diario/crear' : '/diario/actualizar';
            
            const formData = new URLSearchParams();
            if (!isNew) formData.append('id', currentEntryId);
            formData.append('emocion', emocionSelect.value);
            formData.append('descripcion', descripcionTextarea.value.trim());

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        [csrfHeader]: csrfToken 
                    },
                    body: formData.toString()
                });

                if (response.ok) {
                    const message = isNew ? '¬°Entrada creada con √©xito! Recargando...' : '¬°Entrada actualizada con √©xito! Recargando...';
                    showMessage(message);
                    
                    // Recargar la p√°gina despu√©s de un breve delay para que se vea el mensaje
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);

                } else {
                    // Manejar errores espec√≠ficos
                    if (response.status === 403) {
                        showMessage('Error de acceso: Por favor, inicia sesi√≥n nuevamente.', true);
                    } else if (response.status === 400) {
                        showMessage('Error en los datos enviados. Verifica la informaci√≥n.', true);
                    } else {
                        const errorText = await response.text();
                        console.error('Error del servidor:', errorText);
                        showMessage(`Error al guardar: ${response.status}.`, true);
                    }
                }

            } catch (error) {
                console.error('Error de red:', error);
                showMessage('Error de red. No se pudo conectar con el servidor.', true);
            } finally {
                saveBtn.innerHTML = '<i id="save-icon" class="bi bi-save-fill me-2"></i> <span id="save-text">Guardar</span>';
                saveBtn.disabled = false;
            }
        }
        
        // --- Funciones de Eliminaci√≥n CON RECARGA AUTOM√ÅTICA ---
        function showConfirmDeleteModal() {
            confirmModal.classList.remove('hidden');
        }
        
        function hideConfirmDeleteModal() {
            confirmModal.classList.add('hidden');
        }

        async function confirmDeleteEntry() {
            if (currentEntryId === null) return;
            
            hideConfirmDeleteModal();
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i>';

            try {
                const response = await fetch(`/diario/eliminar/${currentEntryId}`, {
                    method: 'DELETE',
                    headers: { [csrfHeader]: csrfToken }
                });

                if (response.status === 204) {
                    showMessage('Entrada eliminada con √©xito. Recargando...', false);
                    
                    // Recargar la p√°gina despu√©s de un breve delay para que se vea el mensaje
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } else if (response.status === 403) {
                    showMessage('Error de acceso: No tienes permiso para eliminar esto.', true);
                } else if (response.status === 404) {
                    showMessage('La entrada no fue encontrada o no te pertenece.', true);
                } else {
                    showMessage(`Error al eliminar: ${response.status}.`, true);
                }

            } catch (error) {
                console.error('Error de red:', error);
                showMessage('Error de red al intentar eliminar.', true);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="bi bi-trash-fill text-xl"></i>';
            }
        }

        // --- L√≥gica del Tema ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                themeToggle.classList.remove('bi-moon-fill');
                themeToggle.classList.add('bi-sun-fill');
            } else {
                document.body.classList.remove('light-mode');
                themeToggle.classList.remove('bi-sun-fill');
                themeToggle.classList.add('bi-moon-fill');
            }
            localStorage.setItem('theme', theme);
        }

        themeToggle.addEventListener('click', toggleTheme);
    </script>
</body>
</html>